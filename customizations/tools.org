* Package
** package sources
#+begin_src emacs-lisp

(require 'package)

(setq package-archives '(
                         ;; ("melpa-stable" . "http://stable.melpa.org/packages/")
                         ("gnu"   . "http://mirrors.tuna.tsinghua.edu.cn/elpa/gnu/")
                         ("melpa" . "http://mirrors.tuna.tsinghua.edu.cn/elpa/melpa/")
                         ("org" . "https://orgmode.org/elpa/")
                         ("melpa" . "https://melpa.org/packages/")
                         ("nongnu" . "https://elpa.nongnu.org/nongnu/")
                         ))

#+end_src
** package install
*** package vc usage: https://tony-zorman.com/posts/use-package-vc.html

#+begin_src emacs-lisp

(package-initialize)

(unless package-archive-contents
  (package-refresh-contents))

;; Initialize use-package on non-Linux platforms
(unless (package-installed-p 'use-package)
  (package-install 'use-package))
(require 'use-package)

;; Auto install the required packages
;; Set missing package vars
(defvar lem-missing-packages '()
  "List populated at startup containing packages needing installation.")
(defvar lem-missing-vc-packages '()
  "List populated at startup containing vc packages requiring installation.")

;; Check for packages
(defun lem-check-missing-packages ()
  "Check for missing packages."
  (interactive)
  ;; Check packages
  (message "%s" "Checking for missing packages.")
  (dolist (p package-selected-packages)
    (unless (package-installed-p p)
      (add-to-list 'lem-missing-packages p 'append)))
  ;; Check vc installed packages (Emacs 29+)
  (when (version< "29" emacs-version)
    (message "%s" "Checking for missing vc packages.")
    (dolist (p package-vc-selected-packages)
      (unless (package-installed-p (car p))
        (add-to-list 'lem-missing-vc-packages (car p) 'append)))))

;; Install packages
(defun lem-install-missing-packages ()
  "Install missing packages from package & package-vc lists."
  (interactive)
  (lem-check-missing-packages)
  (cond ((or lem-missing-packages
             lem-missing-vc-packages)
         (message "Refreshing package database & installing missing packages...")
         (package-install-selected-packages t)
         (setq lem-missing-packages '())
         (package-vc-install-selected-packages)
         (setq lem-missing-vc-packages '()))
        (t
         (message "No missing packages."))))

#+end_src
** modules loading
#+begin_src emacs-lisp
 
(add-to-list 'load-path "~/.emacs.d/vendor")
(add-to-list 'load-path "~/.emacs.d/customizations")
(add-to-list 'load-path "~/.emacs.d/site-lisp/")

(require 'editing) ;; -> F2
(require 'ui) ;; -> F4
(require 'shell-integration)
(require 'navigation) ;; -> F3
(require 'misc)
(require 'init-site-lisp)
(require 'init-core-overriding)
;; Langauage-specific
;; (require 'elisp-editing)
(require 'init-minibuffer-completion)

#+end_src
* Key Binding
** shortcut
#+begin_src emacs-lisp

  ;; å¿«é€Ÿæ‰“å¼€é…ç½®æ–‡ä»¶
  (defun open-init-file-and-eval()
    (interactive)
    (find-file "~/.emacs.d/init.el")
    (eval-buffer))

  (defun open-editing-file()
    (interactive)
    (find-file "~/.emacs.d/customizations/editing.el"))

  (defun open-navigation-file()
    (interactive)
    (find-file "~/.emacs.d/customizations/navigation.el"))

  (defun open-ui-file()
    (interactive)
    (find-file "~/.emacs.d/customizations/ui.el"))

  (defun open-init-org-file()
    (interactive)
    (find-file "~/.emacs.d/customizations/init-org.el"))

  (defun open-misc-file()
    (interactive)
    (find-file "~/.emacs.d/customizations/misc.el"))

  (defun open-tools-file()
    (interactive)
    (find-file "~/.emacs.d/customizations/tools.org"))

  (global-set-key (kbd "<f1>") 'open-init-file-and-eval)
  (global-set-key (kbd "<f2>") 'open-editing-file)
  (global-set-key (kbd "<f3>") 'open-navigation-file)
  (global-set-key (kbd "<f4>") 'open-ui-file)
  (global-set-key (kbd "<f5>") 'open-init-org-file)
  (global-set-key (kbd "<f6>") 'open-misc-file)
  (global-set-key (kbd "<f9>") 'open-tools-file)

#+end_src
** Meow
** Hydra 
https://github.com/abo-abo/hydra

#+begin_src emacs-lisp
;;design a transient key binding
(use-package hydra
  :defer t)
;;use the macro defhydra to define the hydra and its heads
(defhydra hydra-text-scale (global-map "<f12>")
  "scale text"
  ("j" move-line-up "up")
  ("k" move-line-down "down")
  ("f" nil "finished" :exit t))
;; hercules arrives with any other key binding

#+end_src
* Org Mode
** Org Common
#+begin_src emacs-lisp
  (add-hook 'org-mode-hook 'toc-org-mode)
  (use-package org-appear
    :ensure t
    :hook (org-mode . org-appear-mode)
    :config
    (setq org-appear-autolinks t)
    (setq org-appear-autosubmarkers t)
    (setq org-appear-autoentities t)
    (setq org-appear-autokeywords t)
    (setq org-appear-inside-latex t)
    )
  (use-package org
    :ensure nil
    :mode ("\\.org\\'" . org-mode)
    :hook 
    ((org-mode . visual-line-mode) 
     (org-mode . my/org-prettify-symbols) 
     )
    :commands (org-find-exact-headline-in-buffer 
               org-set-tags
               )
    :custom-face
    ;; è®¾ç½®Org modeæ ‡é¢˜ä»¥åŠæ¯çº§æ ‡é¢˜è¡Œçš„å¤§å°
    (org-document-title ((t (:height 1.75 :weight bold))))
    (org-level-1 ((t (:height 1.2 :weight bold))))
    (org-level-2 ((t (:height 1.15 :weight bold))))
    (org-level-3 ((t (:height 1.1 :weight bold))))
    (org-level-4 ((t (:height 1.05 :weight bold))))
    (org-level-5 ((t (:height 1.0 :weight bold))))
    (org-level-6 ((t (:height 1.0 :weight bold))))
    (org-level-7 ((t (:height 1.0 :weight bold))))
    (org-level-8 ((t (:height 1.0 :weight bold))))
    (org-level-9 ((t (:height 1.0 :weight bold))))
    ;; è®¾ç½®ä»£ç å—ç”¨ä¸Šä¸‹è¾¹çº¿åŒ…è£¹
    (org-block-begin-line ((t (:underline t :background unspecified))))
    (org-block-end-line ((t (:overline t :underline nil :background unspecified))))
    :config
    (setq org-startup-with-inline-images t)
    ;; ;; è®¾ç½®æ ‡é¢˜è¡Œä¹‹é—´æ€»æ˜¯æœ‰ç©ºæ ¼ï¼›åˆ—è¡¨ä¹‹é—´æ ¹æ®æƒ…å†µè‡ªåŠ¨åŠ ç©ºæ ¼
    ;; (setq org-blank-before-new-entry '((heading . t)
    ;;                                    (plain-list-item . auto)))
    ;; åœ¨org modeé‡Œç¾åŒ–å­—ç¬¦ä¸²
    ;; ================================
    (defun my/org-prettify-symbols ()
      (setq prettify-symbols-alist
     	  (mapcan (lambda (x) (list x (cons (upcase (car x)) (cdr x))))
     		  '(
     		    ;; ("[ ]"              . 9744)         ; â˜
     		    ;; ("[X]"              . 9745)         ; â˜‘
     		    ;; ("[-]"              . 8863)         ; âŠŸ
     		    ("#+begin_src"      . 9998)         ; âœ
     		    ("#+end_src"        . 9633)         ; â–¡
     		    ("#+begin_example"  . 129083)       ; ğŸ »
     		    ("#+end_example"    . 129081)       ; ğŸ ¹
     		    ("#+results:"       . 9776)         ; â˜°
     		    ("#+attr_latex:"    . "ğŸ„›")
     		    ("#+attr_html:"     . "ğŸ„—")
     		    ("#+attr_org:"      . "ğŸ„")
     		    ("#+name:"          . "ğŸ„")         ; 127261
     		    ("#+caption:"       . "ğŸ„’")         ; 127250
     		    ("#+date:"          . "ğŸ“…")         ; 128197
     		    ("#+author:"        . "ğŸ’")         ; 128100
     		    ("#+setupfile:"     . 128221)       ; ğŸ“
     		    ("#+email:"         . 128231)       ; ğŸ“§
     		    ("#+startup:"       . 10034)        ; âœ²
     		    ("#+options:"       . 9965)         ; â›­
     		    ("#+title:"         . 10162)        ; â²
     		    ("#+subtitle:"      . 11146)        ; â®Š
     		    ("#+downloaded://///:"    . 8650)         ; â‡Š
     		    ("#+language:"      . 128441)       ; ğŸ–¹
     		    ("#+begin_quote"    . 187)          ; Â»
     		    ("#+end_quote"      . 171)          ; Â«
                      ("#+begin_results"  . 8943)         ; â‹¯
                      ("#+end_results"    . 8943)         ; â‹¯
     		    )))
      (setq prettify-symbols-unprettify-at-point t)
      (prettify-symbols-mode 1))
    (setq
     ;; Edit settings
     org-auto-align-tags nil
     org-tags-column 0
     org-catch-invisible-edits 'show-and-error
     org-special-ctrl-a/e t
     org-insert-heading-respect-content t

     ;; Org styling, hide markup etc.
     org-hide-emphasis-markers t
     org-pretty-entities t

     ;; Agenda styling
     org-agenda-tags-column 0
     org-agenda-block-separator ?â”€
     org-agenda-time-grid
     '((daily today require-timed)
       (800 1000 1200 1400 1600 1800 2000)
       " â”„â”„â”„â”„â”„ " "â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„")
     org-agenda-current-time-string
     "â—€â”€â”€ now â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")

    ;; Ellipsis styling
    (setq org-ellipsis "â€¦")
    (set-face-attribute 'org-ellipsis nil :inherit 'default :box nil)
    :custom
    ;; è®¾ç½®Org modeçš„ç›®å½•
    (org-directory "~/Dropbox/org")
    ;; è®¾ç½®ç¬”è®°çš„é»˜è®¤å­˜å‚¨ä½ç½®
    (org-default-notes-file (expand-file-name "capture.org" org-directory))
    ;; å¯ç”¨ä¸€äº›å­æ¨¡å—
    (org-modules '(ol-bibtex ol-gnus ol-info ol-eww org-habit org-protocol))

    ;; TOODçš„å…³é”®è¯è®¾ç½®ï¼Œå¯ä»¥è®¾ç½®ä¸åŒçš„ç»„
    (org-todo-keywords '((sequence "TODO(t)" "HOLD(h!)" "WIP(i!)" "WAIT(w!)" "|" "DONE(d!)" "CANCELLED(c@/!)")
     		       (sequence "REPORT(r)" "BUG(b)" "KNOWNCAUSE(k)" "|" "FIXED(f!)")))

    ;; å½“æ ‡é¢˜è¡ŒçŠ¶æ€å˜åŒ–æ—¶æ ‡ç­¾åŒæ­¥å‘ç”Ÿçš„å˜åŒ–
    ;; Moving a task to CANCELLED adds a CANCELLED tag
    ;; Moving a task to WAIT adds a WAIT tag
    ;; Moving a task to HOLD adds WAIT and HOLD tags
    ;; Moving a task to a done state removes WAIT and HOLD tags
    ;; Moving a task to TODO removes WAIT, CANCELLED, and HOLD tags
    ;; Moving a task to DONE removes WAIT, CANCELLED, and HOLD tags
    (org-todo-state-tags-triggers
     (quote (("CANCELLED" ("CANCELLED" . t))
     	   ("WAIT" ("WAIT" . t))
     	   ("HOLD" ("WAIT") ("HOLD" . t))
     	   (done ("WAIT") ("HOLD"))
     	   ("TODO" ("WAIT") ("CANCELLED") ("HOLD"))
     	   ("DONE" ("WAIT") ("CANCELLED") ("HOLD")))))

    ;; ä½¿ç”¨ä¸“å®¶æ¨¡å¼é€‰æ‹©æ ‡é¢˜æ çŠ¶æ€
    (org-use-fast-todo-selection 'expert)
    ;; çˆ¶å­æ ‡é¢˜æ çŠ¶æ€æœ‰ä¾èµ–
    (org-enforce-todo-dependencies t)
    ;; æ ‡é¢˜æ å’Œä»»åŠ¡å¤é€‰æ¡†æœ‰ä¾èµ–
    (org-enforce-todo-checkbox-dependencies t)
    ;; ä¼˜å…ˆçº§æ ·å¼è®¾ç½®
    (org-priority-faces '((?A :foreground "red")
             		(?B :foreground "orange")
             		(?C :foreground "yellow")))
    ;; ;; æ ‡é¢˜è¡Œå…¨å±€å±æ€§è®¾ç½®
    ;; (org-global-properties '(("EFFORT_ALL" . "0:15 0:30 0:45 1:00 2:00 3:00 4:00 5:00 6:00 7:00 8:00")
    ;;       					   ("APPT_WARNTIME_ALL" . "0 5 10 15 20 25 30 45 60")
    ;;       					   ("RISK_ALL" . "Low Medium High")
    ;;       					   ("STYLE_ALL" . "habit")))
    ;; Org columnsçš„é»˜è®¤æ ¼å¼
    ;; (org-columns-default-format "%25ITEM %TODO %SCHEDULED %DEADLINE %3PRIORITY %TAGS %CLOCKSUM %EFFORT{:}")
    ;; å½“çŠ¶æ€ä»DONEæ”¹æˆå…¶ä»–çŠ¶æ€æ—¶ï¼Œç§»é™¤ CLOSED: [timestamp]
    (org-closed-keep-when-no-todo t)
    ;; DONEæ—¶åŠ ä¸Šæ—¶é—´æˆ³
    (org-log-done 'time)
    ;; é‡å¤æ‰§è¡Œæ—¶åŠ ä¸Šæ—¶é—´æˆ³
    (org-log-repeat 'time)
    ;; Deadlineä¿®æ”¹æ—¶åŠ ä¸Šä¸€æ¡è®°å½•
    (org-log-redeadline 'note)
    ;; Scheduleä¿®æ”¹æ—¶åŠ ä¸Šä¸€æ¡è®°å½•
    (org-log-reschedule 'note)
    ;; ä»¥æŠ½å±‰çš„æ–¹å¼è®°å½•
    (org-log-into-drawer t)
    ;; ç´§æ¥ç€æ ‡é¢˜è¡Œæˆ–è€…è®¡åˆ’/æˆªæ­¢æ—¶é—´æˆ³ååŠ ä¸Šè®°å½•æŠ½å±‰
    (org-log-state-notes-insert-after-drawers nil)

    ;;TODO org-refile ä½¿ç”¨ç¼“å­˜ 

    ;; è®¾ç½®æ ‡ç­¾çš„é»˜è®¤ä½ç½®ï¼Œé»˜è®¤æ˜¯ç¬¬77åˆ—å³å¯¹é½
    (org-tags-column -77)
    ;; è‡ªåŠ¨å¯¹é½æ ‡ç­¾
    (org-auto-align-tags t)
    ;; æ ‡ç­¾ä¸ç»§æ‰¿
    (org-use-tag-inheritance nil)
    ;; åœ¨æ—¥ç¨‹è§†å›¾çš„æ ‡ç­¾ä¸ç»§æ‰¿
    (org-agenda-use-tag-inheritance nil)
    ;; æ ‡ç­¾å¿«é€Ÿé€‰æ‹©
    (org-use-fast-tag-selection t)
    ;; æ ‡ç­¾é€‰æ‹©ä¸éœ€è¦å›è½¦ç¡®è®¤
    (org-fast-tag-selection-single-key t)
    ;; å®šä¹‰äº†æœ‰åºå±æ€§çš„æ ‡é¢˜è¡Œä¹ŸåŠ ä¸Š OREDERD æ ‡ç­¾
    (org-track-ordered-property-with-tag t)
    ;; å§‹ç»ˆå­˜åœ¨çš„çš„æ ‡ç­¾
    (org-tag-persistent-alist '(("read"     . ?r)
     			      ("emacs"    . ?e)
     			      ("study"    . ?s)
     			      ("work"     . ?w)))
    ;; é¢„å®šä¹‰å¥½çš„æ ‡ç­¾
    (org-tag-alist '((:startgroup)
     		   ("linux"    . ?l)
     		   ("apple"    . ?a)
     		   ("noexport" . ?n)
     		   ("ignore"   . ?i)
     		   ("toc"      . ?t)
     		   (:endgroup)))

    ;; å½’æ¡£è®¾ç½®
    (org-archive-location "%s_archive::datetree/")
    )

#+end_src
** org-babel
#+begin_src emacs-lisp
;;config babel languages
(with-eval-after-load 'org
  (org-babel-do-load-languages
   'org-babel-load-languages
   '((emacs-lisp . t)
     (python . t)))
  (push '("conf-unix" . conf-unix) org-src-lang-modes));; what is this?

;; structure templates
(with-eval-after-load 'org
  ;; This is needed as of Org 9.2
  (require 'org-tempo)

  (add-to-list 'org-structure-template-alist '("sh" . "src shell"))
  (add-to-list 'org-structure-template-alist '("el" . "src emacs-lisp"))
  (add-to-list 'org-structure-template-alist '("py" . "src python"))
  (global-set-key (kbd "C-< s") 'tempo-template-org-src-emacs-lisp))
#+end_src
** org-capture
#+begin_src elisp

  (global-set-key (kbd "C-c c") 'org-capture)
  (setq org-default-notes-file "~/org/inbox.org")

  (use-package org-capture
    :ensure nil
    :bind ("\e\e c" . (lambda () (interactive) (org-capture)))
    :hook ((org-capture-mode . (lambda ()
                                 (setq-local org-complete-tags-always-offer-all-agenda-tags t)))
           (org-capture-mode . delete-other-windows))
    :custom
    (org-capture-use-agenda-date nil)
    ;; define common template
    (org-capture-templates `(
                             ("t" "Task")
                             ("tt" "Task" entry (file+headline "Task.org" "TO-DO Queque")
                              "** TODO %?   %^g"
                              :prepend t)
                             ("tc" "Class-Schedule" entry (file+headline "Task.org" "Class-Schedule")
                              "* TODO %i%?"
                              :empty-lines-after 1
                              :prepend t)
                             ("n" "Notes" entry (file+headline "Reading-Summary.org" "Notes")
                              "* %? %^g\n%i\n"
                              :empty-lines-after 1)
                             ;; For EWW
                             ;; ("b" "Bookmarks" entry (file+headline "capture.org" "Bookmarks")
                             ;;  "* %:description\n\n%a%?"
                             ;;  :empty-lines 1
                             ;;  :immediate-finish t)
                             ;; ("j" "Journal")
                             ;; ("jt" "Today's TODO" entry (file+olp+datetree "Journal.org" "Today's TODO")
                             ;;  "* TODO %U [/] \n - [ ] %?"
                             ;;  :empty-lines 1
                             ;;  :jump-to-captured t
                             ;;  :prepend f)
                             ("j" "diary" entry (file+olp+datetree "Journal.org")
                              "* %U - :%?"
                              :empty-lines-after 1
                              :prepend f)
                             ("w" "Web site" entry
                              (file "")
                              "* %a :website:\n\n%U %?\n\n%:initial")
                             ))
    )

#+end_src
** org-zettle-ref
#+begin_src emacs-lisp

    (use-package org-zettel-ref-mode
      :ensure nil
      :vc (:url "https://github.com/yibie/org-zettel-ref-mode" :rev :newest)
      ;; :load-path "~/.emacs.d/site-lisp/org-zettel-ref-mode/"
      :init 
      (setq org-zettel-ref-overview-directory "~/Dropbox/Notes")
      :config
      (setq org-zettel-ref-mode-type 'denote)
      ;; (setq org-zettel-ref-mode-type 'org-roam)  
      ;; (setq org-zettel-ref-mode-type 'normal)  
      (setq org-zettel-ref-python-file "~/.emacs.d/elpa/org-zettel-ref-mode/convert-to-org.py")
      (setq org-zettel-ref-temp-folder "~/Dropbox/book-store/temp_convert/")
      (setq org-zettel-ref-reference-folder "~/Dropbox/book-store/converted_org")
      (setq org-zettel-ref-archive-folder "~/Dropbox/book-store/archives/")
      (setq org-zettel-ref-python-environment 'venv)  ; æˆ– 'system, 'venv
  (setq org-zettel-ref-python-env-name "venv")  ; å¦‚æœä½¿ç”¨ Conda æˆ– venv
      (setq org-zettel-ref-debug t))
#+end_src
** org-calendar
#+begin_src emacs-lisp
  (use-package calendar
    :ensure nil
    :hook (calendar-today-visible . calendar-mark-today)
    :custom
    ;; æ˜¯å¦æ˜¾ç¤ºä¸­å›½èŠ‚æ—¥ï¼Œæˆ‘ä»¬ä½¿ç”¨ `cal-chinese-x' æ’ä»¶
    (calendar-chinese-all-holidays-flag nil)
    ;; æ˜¯å¦æ˜¾ç¤ºèŠ‚æ—¥
    (calendar-mark-holidays-flag t)
    ;; æ˜¯å¦æ˜¾ç¤ºEmacsçš„æ—¥è®°ï¼Œæˆ‘ä»¬ä½¿ç”¨orgçš„æ—¥è®°
    (calendar-mark-diary-entries-flag nil)
    ;; æ•°å­—æ–¹å¼æ˜¾ç¤ºæ—¶åŒºï¼Œå¦‚ +0800ï¼Œé»˜è®¤æ˜¯å­—ç¬¦æ–¹å¼å¦‚ CST
    (calendar-time-zone-style 'numeric)
    ;; æ—¥æœŸæ˜¾ç¤ºæ–¹å¼ï¼šyear/month/day
    (calendar-date-style 'iso)
    ;; ä¸­æ–‡å¤©å¹²åœ°æ”¯è®¾ç½®
    (calendar-chinese-celestial-stem ["ç”²" "ä¹™" "ä¸™" "ä¸" "æˆŠ" "å·±" "åºš" "è¾›" "å£¬" "ç™¸"])
    (calendar-chinese-terrestrial-branch ["å­" "ä¸‘" "å¯…" "å¯" "è¾°" "å·³" "åˆ" "æœª" "ç”³" "é…‰" "æˆŒ" "äº¥"])
    ;; è®¾ç½®ä¸­æ–‡æœˆä»½
    (calendar-month-name-array ["ä¸€æœˆ" "äºŒæœˆ" "ä¸‰æœˆ" "å››æœˆ" "äº”æœˆ" "å…­æœˆ" "ä¸ƒæœˆ" "å…«æœˆ" "ä¹æœˆ" "åæœˆ" "åä¸€æœˆ" "åäºŒæœˆ"])
    ;; è®¾ç½®æ˜ŸæœŸæ ‡é¢˜æ˜¾ç¤º
    (calendar-day-name-array ["æ—¥" "ä¸€" "äºŒ" "ä¸‰" "å››" "äº”" "å…­"])
    ;; å‘¨ä¸€ä½œä¸ºä¸€å‘¨ç¬¬ä¸€å¤©
    (calendar-week-start-day 1)
    )

  ;; æ—¶é—´è§£æå¢åŠ ä¸­æ–‡æ‹¼éŸ³
  (use-package parse-time
    :ensure nil
    :defer t
    :config
    (setq parse-time-months
          (append '(("yiy" . 1) ("ery" . 2) ("sany" . 3)
                    ("siy" . 4) ("wuy" . 5) ("liuy" . 6)
                    ("qiy" . 7) ("bay" . 8) ("jiuy" . 9)
                    ("shiy" . 10) ("shiyiy" . 11) ("shiery" . 12)
                    ("yiyue" . 1) ("eryue" . 2) ("sanyue" . 3)
                    ("siyue" . 4) ("wuyue" . 5) ("liuyue" . 6)
                    ("qiyue" . 7) ("bayue" . 8) ("jiuyue" . 9)
                    ("shiyue" . 10) ("shiyiyue" . 11) ("shieryue" . 12))
                  parse-time-months))

    (setq parse-time-weekdays
          (append '(("zri" . 0) ("zqi" . 0)
                    ("zyi" . 1) ("zer" . 2) ("zsan" . 3)
                    ("zsi" . 4) ("zwu" . 5) ("zliu" . 6)
                    ("zr" . 0) ("zq" . 0)
                    ("zy" . 1) ("ze" . 2) ("zs" . 3)
                    ("zsi" . 4) ("zw" . 5) ("zl" . 6))
                  parse-time-weekdays)))

  ;; ä¸­å›½èŠ‚æ—¥è®¾ç½®
  (use-package cal-china-x
    :ensure t
    :commands cal-china-x-setup
    :hook (after-init . cal-china-x-setup)
    :config
    ;; é‡è¦èŠ‚æ—¥è®¾ç½®
    (setq cal-china-x-important-holidays cal-china-x-chinese-holidays)
    ;; æ‰€æœ‰èŠ‚æ—¥è®¾ç½®
    (setq cal-china-x-general-holidays
          '(;;å…¬å†èŠ‚æ—¥
            (holiday-fixed 1 1 "å…ƒæ—¦")
            (holiday-fixed 2 14 "æƒ…äººèŠ‚")
            (holiday-fixed 3 8 "å¦‡å¥³èŠ‚")
            (holiday-fixed 3 14 "ç™½è‰²æƒ…äººèŠ‚")
            (holiday-fixed 4 1 "æ„šäººèŠ‚")
            (holiday-fixed 5 1 "åŠ³åŠ¨èŠ‚")
            (holiday-fixed 5 4 "é’å¹´èŠ‚")
            (holiday-float 5 0 2 "æ¯äº²èŠ‚")
            (holiday-fixed 6 1 "å„¿ç«¥èŠ‚")
            (holiday-float 6 0 3 "çˆ¶äº²èŠ‚")
            (holiday-fixed 9 10 "æ•™å¸ˆèŠ‚")
            (holiday-fixed 10 1 "å›½åº†èŠ‚")
            (holiday-fixed 10 2 "å›½åº†èŠ‚")
            (holiday-fixed 10 3 "å›½åº†èŠ‚")
            (holiday-fixed 10 24 "ç¨‹åºå‘˜èŠ‚")
            (holiday-fixed 11 11 "åŒ11è´­ç‰©èŠ‚")
            (holiday-fixed 12 25 "åœ£è¯èŠ‚")
            ;; å†œå†èŠ‚æ—¥
            (holiday-lunar 12 30 "æ˜¥èŠ‚" 0)
            (holiday-lunar 1 1 "æ˜¥èŠ‚" 0)
            (holiday-lunar 1 2 "æ˜¥èŠ‚" 0)
            (holiday-lunar 1 15 "å…ƒå®µèŠ‚" 0)
            (holiday-solar-term "æ¸…æ˜" "æ¸…æ˜èŠ‚")
            (holiday-solar-term "å°å¯’" "å°å¯’")
            (holiday-solar-term "å¤§å¯’" "å¤§å¯’")
            (holiday-solar-term "ç«‹æ˜¥" "ç«‹æ˜¥")
            (holiday-solar-term "é›¨æ°´" "é›¨æ°´")
            (holiday-solar-term "æƒŠè›°" "æƒŠè›°")
            (holiday-solar-term "æ˜¥åˆ†" "æ˜¥åˆ†")
            (holiday-solar-term "è°·é›¨" "è°·é›¨")
            (holiday-solar-term "ç«‹å¤" "ç«‹å¤")
            (holiday-solar-term "å°æ»¡" "å°æ»¡")
            (holiday-solar-term "èŠ’ç§" "èŠ’ç§")
            (holiday-solar-term "å¤è‡³" "å¤è‡³")
            (holiday-solar-term "å°æš‘" "å°æš‘")
            (holiday-solar-term "å¤§æš‘" "å¤§æš‘")
            (holiday-solar-term "ç«‹ç§‹" "ç«‹ç§‹")
            (holiday-solar-term "å¤„æš‘" "å¤„æš‘")
            (holiday-solar-term "ç™½éœ²" "ç™½éœ²")
            (holiday-solar-term "ç§‹åˆ†" "ç§‹åˆ†")
            (holiday-solar-term "å¯’éœ²" "å¯’éœ²")
            (holiday-solar-term "éœœé™" "éœœé™")
            (holiday-solar-term "ç«‹å†¬" "ç«‹å†¬")
            (holiday-solar-term "å°é›ª" "å°é›ª")
            (holiday-solar-term "å¤§é›ª" "å¤§é›ª")
            (holiday-solar-term "å†¬è‡³" "å†¬è‡³")
            (holiday-lunar 5 5 "ç«¯åˆèŠ‚" 0)
            (holiday-lunar 8 15 "ä¸­ç§‹èŠ‚" 0)
            (holiday-lunar 7 7 "ä¸ƒå¤•æƒ…äººèŠ‚" 0)
            (holiday-lunar 12 8 "è…Šå…«èŠ‚" 0)
            (holiday-lunar 9 9 "é‡é˜³èŠ‚" 0)))
    ;; è®¾ç½®æ—¥å†çš„èŠ‚æ—¥ï¼Œé€šç”¨èŠ‚æ—¥å·²ç»åŒ…å«äº†æ‰€æœ‰èŠ‚æ—¥
    (setq calendar-holidays (append cal-china-x-general-holidays)))

#+end_src
** Org-roam
*** org-roam
#+begin_src emacs-lisp
(use-package org-roam
  :ensure t
  :custom
  (org-roam-directory (file-truename "~/Dropbox/org-roam-files/"))
  :bind (("C-c n l" . org-roam-buffer-toggle)
         ("C-c n f" . org-roam-node-find)
         ("C-c n g" . org-roam-graph)
         ("C-c n i" . org-roam-node-insert)
         ("C-c n c" . org-roam-capture)
         ;; Dailies
         ("C-c n j" . org-roam-dailies-capture-today))
  :config
  ;; If you're using a vertical completion framework, you might want a more informative completion interface
  (setq org-roam-node-display-template (concat "${title:*} " (propertize "${tags:10}" 'face 'org-tag)))
  (org-roam-db-autosync-mode)
  ;; If using org-roam-protocol
  (require 'org-roam-protocol))

#+end_src
*** org-roam-ui
org-roam-ui requires org-roam, websocket, simple-httpd, f and Emacs >= 27 for fast JSON parsing.
** org-modern
#+begin_src emacs-lisp
(require 'org-modern)
;; Option 1: Per buffer
(add-hook 'org-mode-hook #'org-modern-mode)
(add-hook 'org-agenda-finalize-hook #'org-modern-agenda)

(setq
 ;; Edit settings
 org-auto-align-tags nil
 org-tags-column 0
 org-catch-invisible-edits 'show-and-error
 org-special-ctrl-a/e t
 org-insert-heading-respect-content t

 ;; Org styling, hide markup etc.
 org-hide-emphasis-markers t
 org-pretty-entities t

 ;; Agenda styling
 org-agenda-tags-column 0
 org-agenda-block-separator ?â”€
 org-agenda-time-grid
 '((daily today require-timed)
   (800 1000 1200 1400 1600 1800 2000)
   " â”„â”„â”„â”„â”„ " "â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„")
 org-agenda-current-time-string
 "â—€â”€â”€ now â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")

;; Ellipsis styling
(setq org-ellipsis "â€¦")
(set-face-attribute 'org-ellipsis nil :inherit 'default :box nil)

(use-package org-modern
  :ensure t
  :hook (after-init . (lambda ()
                        (setq org-modern-hide-stars 'leading)
                        (global-org-modern-mode t)))
  :config
  ;; æ ‡é¢˜è¡Œå‹å·å­—ç¬¦
  (setq org-modern-star ["â—‰" "â—‹" "âœ¸" "âœ³" "â—ˆ" "â—‡" "âœ¿" "â€" "âœœ"])
  ;; é¢å¤–çš„è¡Œé—´è·ï¼Œ0.1è¡¨ç¤º10%ï¼Œ1è¡¨ç¤º1px
  (setq-default line-spacing 0.1)
  ;; tagè¾¹æ¡†å®½åº¦ï¼Œè¿˜å¯ä»¥è®¾ç½®ä¸º `auto' å³è‡ªåŠ¨è®¡ç®—
  (setq org-modern-label-border 1)
  ;; è®¾ç½®è¡¨æ ¼ç«–çº¿å®½åº¦ï¼Œé»˜è®¤ä¸º3
  (setq org-modern-table-vertical 2)
  ;; è®¾ç½®è¡¨æ ¼æ¨ªçº¿ä¸º0ï¼Œé»˜è®¤ä¸º0.1
  (setq org-modern-table-horizontal 0)
  ;; å¤é€‰æ¡†ç¾åŒ–
  (setq org-modern-checkbox
        '((?X . #("â–¢âœ“" 0 2 (composition ((2)))))
          (?- . #("â–¢â€“" 0 2 (composition ((2)))))
          (?\s . #("â–¢" 0 1 (composition ((1)))))))
  ;; åˆ—è¡¨ç¬¦å·ç¾åŒ–
  (setq org-modern-list
        '((?- . "â€¢")
          (?+ . "â—¦")
          (?* . "â–¹")))
  ;; ä»£ç å—å·¦è¾¹åŠ ä¸Šä¸€æ¡ç«–è¾¹çº¿ï¼ˆéœ€è¦Org modeé¡¶å¤´ï¼Œå¦‚æœå¯ç”¨äº† `visual-fill-column-mode' ä¼šå¾ˆéš¾çœ‹ï¼‰
  (setq org-modern-block-fringe t)
  ;; ä»£ç å—ç±»å‹ç¾åŒ–ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† `prettify-symbols-mode'
  (setq org-modern-block-name nil)
  ;; #+å…³é”®å­—ç¾åŒ–ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† `prettify-symbols-mode'
  (setq org-modern-keyword nil)
  )

#+end_src
** org-remark
#+begin_src emacs-lisp
(use-package org-remark
  :bind (;; :bind keyword also implicitly defers org-remark itself.
         ;; Keybindings before :map is set for global-map.
         ("C-c n m" . org-remark-mark)
         ("C-c n l" . org-remark-mark-line)
         :map org-remark-mode-map
         ("C-c n o" . org-remark-open)
         ("C-c n ]" . org-remark-view-next)
         ("C-c n [" . org-remark-view-prev)
         ("C-c n r" . org-remark-remove)
         ("C-c n d" . org-remark-delete))
  ;; Alternative way to enable `org-remark-global-tracking-mode' in
  ;; `after-init-hook'.
  ;; :hook (after-init . org-remark-global-tracking-mode)
  :init
  ;; It is recommended that `org-remark-global-tracking-mode' be
  ;; enabled when Emacs initializes. Alternatively, you can put it to
  ;; `after-init-hook' as in the comment above
  (org-remark-global-tracking-mode +1)
  ;; :config
  ;; (use-package org-remark-info :after info :config (org-remark-info-mode +1))
  ;; (use-package org-remark-eww  :after eww  :config (org-remark-eww-mode +1))
  ;; (use-package org-remark-nov  :after nov  :config (org-remark-nov-mode +1))
  )
#+end_src
* Desktop, window  and layouts
** shackle 
https://depp.brause.cc/shackle/

#+begin_src emacs-lisp
  (use-package shackle
      :config
      (progn
        (setq shackle-lighter "")
        (setq shackle-select-reused-windows nil) ; default nil
        (setq shackle-default-alignment 'below) ; default below
        (setq shackle-default-size 0.4) ; default 0.5

        (setq shackle-rules
              ;; CONDITION(:regexp)            :select     :inhibit-window-quit   :size+:align|:other     :same|:popup
              '((compilation-mode              :select nil                                               )
                ("*undo-tree*"                                                    :size 0.25 :align right)
                ("*eshell*"                    :select t                          :other t               )
                ("*Shell Command Output*"      :select nil                                               )
                ("\\*Async Shell.*\\*"                      :regexp t :ignore t                          )
                (occur-mode                    :select nil                                   :align t     :size 0.3)
                ("*Help*"                      :select t   :inhibit-window-quit nil :other t   :align right)
                (helpful-mode                  :select nil                                   :align right :size 0.3)
                ("*Completions*"                                                  :size 0.3  :align t    )
                ("*Messages*"                  :select nil :inhibit-window-quit nil :align right :size 0.3 :popup t)
                ("\\*[Wo]*Man.*\\*"  :regexp t :select t   :inhibit-window-quit t :other t               )
                ("\\*poporg.*\\*"    :regexp t :select t                          :other t               )
                ("\\`\\*helm.*?\\*\\'" :regexp t                                  :size 0.3  :align t    )
                ("*Calendar*"                  :select t                          :size 0.3  )
                ("*info*"                      :select t   :inhibit-window-quit t                         :same t)
                (magit-status-mode             :select t   :inhibit-window-quit t                         :same t)
                (magit-log-mode                :select t   :inhibit-window-quit t                         :same t)
  	      ("*Capture*" :select t :inhibit-window-quit nil :size 0.3 :align right)
                (org-capture-mode :select t :inhibit-window-quit nil :align right :size 0.4)
                ))

        (shackle-mode 1)))

#+end_src
;; Elements of the `shackle-rules' alist:
;;
;; |-----------+------------------------+--------------------------------------------------|
;; | CONDITION | symbol                 | Major mode of the buffer to match                |
;; |           | string                 | Name of the buffer                               |
;; |           |                        | - which can be turned into regexp matching       |
;; |           |                        | by using the :regexp key with a value of t       |
;; |           |                        | in the key-value part                            |
;; |           | list of either         | a list groups either symbols or strings          |
;; |           | symbol or string       | (as described earlier) while requiring at        |
;; |           |                        | least one element to match                       |
;; |           | t                      | t as the fallback rule to follow when no         |
;; |           |                        | other match succeeds.                            |
;; |           |                        | If you set up a fallback rule, make sure         |
;; |           |                        | it's the last rule in shackle-rules,             |
;; |           |                        | otherwise it will always be used.                |
;; |-----------+------------------------+--------------------------------------------------|
;; | KEY-VALUE | :select t              | Select the popped up window. The                 |
;; |           |                        | `shackle-select-reused-windows' option makes     |
;; |           |                        | this the default for windows already             |
;; |           |                        | displaying the buffer.                           |
;; |-----------+------------------------+--------------------------------------------------|
;; |           | :inhibit-window-quit t | Special buffers usually have `q' bound to        |
;; |           |                        | `quit-window' which commonly buries the buffer   |
;; |           |                        | and deletes the window. This option inhibits the |
;; |           |                        | latter which is especially useful in combination |
;; |           |                        | with :same, but can also be used with other keys |
;; |           |                        | like :other as well.                             |
;; |-----------+------------------------+--------------------------------------------------|
;; |           | :ignore t              | Skip handling the display of the buffer in       |
;; |           |                        | question. Keep in mind that while this avoids    |
;; |           |                        | switching buffers, popping up windows and        |
;; |           |                        | displaying frames, it does not inhibit what may  |
;; |           |                        | have preceded this command, such as the          |
;; |           |                        | creation/update of the buffer to be displayed.   |
;; |-----------+------------------------+--------------------------------------------------|
;; |           | :same t                | Display buffer in the current window.            |
;; |           | :popup t               | Pop up a new window instead of displaying        |
;; |           | *mutually exclusive*   | the buffer in the current one.                   |
;; |-----------+------------------------+--------------------------------------------------|
;; |           | :other t               | Reuse the window `other-window' would select if  |
;; |           | *must not be used      | there's more than one window open, otherwise pop |
;; |           | with :align, :size*    | up a new window. When used in combination with   |
;; |           |                        | the :frame key, do the equivalent to             |
;; |           |                        | other-frame or a new frame                       |
;; |-----------+------------------------+--------------------------------------------------|
;; |           | :align                 | Align a new window at the respective side of     |
;; |           | 'above, 'below,        | the current frame or with the default alignment  |
;; |           | 'left, 'right,         | (customizable with `shackle-default-alignment')  |
;; |           | or t (default)         | by deleting every other window than the          |
;; |           |                        | currently selected one, then wait for the window |
;; |           |                        | to be "dealt" with. This can either happen by    |
;; |           |                        | burying its buffer with q or by deleting its     |
;; |           |                        | window with C-x 0.                               |
;; |           | :size                  | Aligned window use a default ratio of 0.5 to     |
;; |           | a floating point       | split up the original window in half             |
;; |           | value between 0 and 1  | (customizable with `shackle-default-size'), the  |
;; |           | is interpreted as a    | size can be changed on a per-case basis by       |
;; |           | ratio. An integer >=1  | providing a different floating point value like  |
;; |           | is interpreted as a    | 0.33 to make it occupy a third of the original   |
;; |           | number of lines.       | window's size.                                   |
;; |-----------+------------------------+--------------------------------------------------|
;; |           | :frame t               | Pop buffer to a frame instead of a window.       |
;; |-----------+------------------------+--------------------------------------------------|
;;
;; http://emacs.stackexchange.com/a/13687/115
;; Don't show Async Shell Command buffers

** popper
https://github.com/karthink/popper
#+begin_src emacs-lisp
  (use-package popper
    :ensure t
    :bind (("C-`"   . popper-toggle)
         ("M-`"   . popper-cycle)
         ("C-M-`" . popper-toggle-type))
    :init
    (setq popper-reference-buffers
          '("\\*Messages\\*"
            "\\*Async Shell Command\\*"
            help-mode
            helpful-mode
            occur-mode
            pass-view-mode
            "^\\*eshell.*\\*$" eshell-mode ;; eshell as a popup
            "^\\*shell.*\\*$"  shell-mode  ;; shell as a popup
            ("\\*corfu\\*" . hide)
            (compilation-mode . hide)
            ibuffer-mode
            debugger-mode
            ;; derived from `fundamental-mode' and fewer than 10 lines will be considered a popup
            (lambda (buf) (with-current-buffer buf
                            (and (derived-mode-p 'fundamental-mode)
                                 (< (count-lines (point-min) (point-max))
                                    10))))
            )
          )
    (popper-mode +1)
    (popper-echo-mode +1)
    :config
    ;; group by project.el, projectile, directory or perspective
    (setq popper-group-function nil)

    ;; pop in child frame or not
    (setq popper-display-function #'display-buffer-in-child-frame)

    ;; use `shackle.el' to control popup
    (setq popper-display-control nil)
    )

#+end_src
** tab-line
https://www.reddit.com/r/emacs/comments/1c3oqqh/modern_tabs_in_emacs/

#+begin_src emacs-lisp 
;; Taken from https://andreyor.st/posts/2020-05-10-making-emacs-tabs-look-like-in-atom/
;; https://github.com/andreyorst/dotfiles/blob/740d346088ce5a51804724659a895d13ed574f81/.config/emacs/README.org#tabline

(defun my/set-tab-theme ()
  (let ((bg (face-attribute 'mode-line :background))
        (fg (face-attribute 'default :foreground))
	(hg (face-attribute 'default :background))
        (base (face-attribute 'mode-line :background))
        (box-width (/ (line-pixel-height) 4)))
    (set-face-attribute 'tab-line nil
			:background base
			:foreground fg
			:height 0.8
			:inherit nil
			:box (list :line-width -1 :color base)
			)
    (set-face-attribute 'tab-line-tab nil
			:foreground fg
			:background bg
			:weight 'normal
			:inherit nil
			:box (list :line-width box-width :color bg))
    (set-face-attribute 'tab-line-tab-inactive nil
			:foreground fg
			:background base
			:weight 'normal
			:inherit nil
			:box (list :line-width box-width :color base))
    (set-face-attribute 'tab-line-highlight nil
			:foreground fg
			:background hg
			:weight 'normal
			:inherit nil
			:box (list :line-width box-width :color hg))
    (set-face-attribute 'tab-line-tab-current nil
			:foreground fg
			:background hg
			:weight 'normal
			:inherit nil
			:box (list :line-width box-width :color hg))))

(defun my/tab-line-name-buffer (buffer &rest _buffers)
  "Create name for tab with padding and truncation.
If buffer name is shorter than `tab-line-tab-max-width' it gets
centered with spaces, otherwise it is truncated, to preserve
equal width for all tabs.  This function also tries to fit as
many tabs in window as possible, so if there are no room for tabs
with maximum width, it calculates new width for each tab and
truncates text if needed.  Minimal width can be set with
`tab-line-tab-min-width' variable."
  (with-current-buffer buffer
    (let* ((window-width (window-width (get-buffer-window)))
           (tab-amount (length (tab-line-tabs-window-buffers)))
           (window-max-tab-width (if (>= (* (+ tab-line-tab-max-width 3) tab-amount) window-width)
                                     (/ window-width tab-amount)
                                   tab-line-tab-max-width))
           (tab-width (- (cond ((> window-max-tab-width tab-line-tab-max-width)
                                tab-line-tab-max-width)
                               ((< window-max-tab-width tab-line-tab-min-width)
                                tab-line-tab-min-width)
                               (t window-max-tab-width))
                         3)) ;; compensation for ' x ' button
           (buffer-name (string-trim (buffer-name)))
           (name-width (length buffer-name)))
      (if (>= name-width tab-width)
          (concat  " " (truncate-string-to-width buffer-name (- tab-width 2)) "â€¦")
        (let* ((padding (make-string (+ (/ (- tab-width name-width) 2) 1) ?\s))
               (buffer-name (concat padding buffer-name)))
          (concat buffer-name (make-string (- tab-width (length buffer-name)) ?\s)))))))

(defun tab-line-close-tab (&optional e)
  "Close the selected tab.
If tab is presented in another window, close the tab by using
`bury-buffer` function.  If tab is unique to all existing
windows, kill the buffer with `kill-buffer` function.  Lastly, if
no tabs left in the window, it is deleted with `delete-window`
function."
  (interactive "e")
  (let* ((posnp (event-start e))
         (window (posn-window posnp))
         (buffer (get-pos-property 1 'tab (car (posn-string posnp)))))
    (with-selected-window window
      (let ((tab-list (tab-line-tabs-window-buffers))
            (buffer-list (flatten-list
                          (seq-reduce (lambda (list window)
                                        (select-window window t)
                                        (cons (tab-line-tabs-window-buffers) list))
                                      (window-list) nil))))
        (select-window window)
        (if (> (seq-count (lambda (b) (eq b buffer)) buffer-list) 1)
            (progn
              (if (eq buffer (current-buffer))
                  (bury-buffer)
                (set-window-prev-buffers window (assq-delete-all buffer (window-prev-buffers)))
                (set-window-next-buffers window (delq buffer (window-next-buffers))))
              (unless (cdr tab-list)
                (ignore-errors (delete-window window))))
          (and (kill-buffer buffer)
               (unless (cdr tab-list)
                 (ignore-errors (delete-window window)))))))))

(unless (version< emacs-version "27")
  (use-package tab-line
    :ensure nil
    :hook (after-init . global-tab-line-mode)
    :config

    (defcustom tab-line-tab-min-width 10
      "Minimum width of a tab in characters."
      :type 'integer
      :group 'tab-line)

    (defcustom tab-line-tab-max-width 30
      "Maximum width of a tab in characters."
      :type 'integer
      :group 'tab-line)

    (setq tab-line-close-button-show t
          tab-line-new-button-show nil
          tab-line-separator ""
          tab-line-tab-name-function #'my/tab-line-name-buffer
          tab-line-right-button (propertize (if (char-displayable-p ?â–¶) " â–¶ " " > ")
                                            'keymap tab-line-right-map
                                            'mouse-face 'tab-line-highlight
                                            'help-echo "Click to scroll right")
          tab-line-left-button (propertize (if (char-displayable-p ?â—€) " â—€ " " < ")
                                           'keymap tab-line-left-map
                                           'mouse-face 'tab-line-highlight
                                           'help-echo "Click to scroll left")
          tab-line-close-button (propertize (if (char-displayable-p ?Ã—) " Ã— " " x ")
                                            'keymap tab-line-tab-close-map
                                            'mouse-face 'tab-line-close-highlight
                                            'help-echo "Click to close tab"))

    (my/set-tab-theme)

    ;;(dolist (mode '(ediff-mode process-menu-mode term-mode vterm-mode))
    ;;(add-to-list 'tab-line-exclude-modes mode))
    (dolist (mode '(ediff-mode process-menu-mode))
      (add-to-list 'tab-line-exclude-modes mode))
    ))

(global-tab-line-mode t)
#+end_src
** workgroup2
#+begin_src emacs-lisp
(use-package workgroups2
      :init (setq wg-prefix-key (kbd "C-c w"))
      :config
      (workgroups-mode 1)
      (setq wg-session-file "~/.emacs.d/var/workgroups"))
#+end_src
** desktop save/restore/recovery
#+begin_src emacs-lisp

    ;; Restore Opened Files
    ;; (progn
    ;;   (desktop-save-mode 1)
    ;;   ;; save when quit
    ;;   (setq desktop-save t)

    ;;   ;; no ask if crashed
    ;;   (setq desktop-load-locked-desktop t)
    ;;   (setq desktop-restore-frames t)
    ;;   (setq desktop-auto-save-timeout 300)

    ;;   ;; save some global vars
    ;;   (setq desktop-globals-to-save nil)
    ;;   ;; 2023-09-16 default
    ;;   ;; '(desktop-missing-file-warning tags-file-name tags-table-list search-ring regexp-search-ring register-alist file-name-history)
    ;;   (setq desktop-dirname "~/.emacs.d/var/desktop/")
    ;; )

    ;; (progn
    ;;   (require ' desktop-recover)
    ;;   ;; optionallly:
    ;;   (setq desktop-recover-location
    ;;         (desktop-recover-fixdir "~/.emacs.d/var/desktop/")) 
    ;;   ;; Brings up the interactive buffer restore menu
    ;;   (desktop-recover-interactive)
    ;;   ;; Note that after using this menu, your desktop will be saved
    ;;   ;; automatically (triggered by the auto-save mechanism).
    ;;   ;; For finer-grained control of the frequency of desktop saves,
    ;;   ;; you can add the standard keybindings to your set-up:
    ;;   (desktop-recover-define-global-key-bindings "\C-c%")
    ;; )
#+end_src
* Gptel -AI copilot
#+begin_src emacs-lisp
  (add-to-list 'load-path "~/.emacs.d/site-lisp/copilot.el-main")
  (require 'copilot)
  (add-hook 'prog-mode-hook 'copilot-mode)
  ;; (define-key copilot-completion-map (kbd "<tab>") 'copilot-accept-completion)
  (define-key copilot-completion-map (kbd "M-w") 'copilot-accept-completion-by-word)
  (define-key copilot-completion-map (kbd "M-q") 'copilot-accept-completion-by-line)

  (use-package gptel
    :ensure t
    :config
    ;; default backend configuration
    ;; (setq
    ;;  gptel-model "codegeex4:latest"
    ;;  gptel-backend (gptel-make-ollama "Ollama"
    ;;                  :host "localhost:11434"
    ;;                  :stream t
    ;;                  :models '("codegeex4:latest")))

    ;; DeepSeek offers an OpenAI compatible API
    (defun get-openai-api-key ()
      "Return the OpenAI API key from ~/.authinfo."
      (let ((authinfo-file (expand-file-name "~/.authinfo")))
        (with-temp-buffer
          (insert-file-contents authinfo-file)
          (goto-char (point-min))
          (when (re-search-forward "^machine api\\.deepseek\\.com login apikey password \\(\\S-+\\)$" nil t)
            (match-string 1)))))

    (setq gptel-model   "deepseek-chat"
          gptel-backend
          (gptel-make-openai "DeepSeek"     ;Any name you want
            :host "api.deepseek.com"
            :endpoint "/chat/completions"
            :stream t
            :key (get-openai-api-key)             ;can be a function that returns the key
            :models '("deepseek-chat" "deepseek-coder")))

    )

  (use-package immersive-translate
    :ensure t
    :config
    (add-hook 'elfeed-show-mode-hook #'immersive-translate-setup)
    (add-hook 'nov-pre-html-render-hook #'immersive-translate-setup)
    )
  (setq immersive-translate-backend 'DeepSeek
        immersive-translate-chatgpt-host "api.deepseek.com")

#+end_src

#+RESULTS:
: api.deepseek.com

* Blog-Publish
#+begin_src emacs-lisp

(use-package ox-hugo
  :ensure t
  :after ox)

#+end_src

* Reading
** Common
*** Shrface

#+begin_src emacs-lisp
(with-eval-after-load 'nov
  (define-key nov-mode-map (kbd "<tab>") 'shrface-outline-cycle)
  (define-key nov-mode-map (kbd "S-<tab>") 'shrface-outline-cycle-buffer)
  (define-key nov-mode-map (kbd "C-t") 'shrface-toggle-bullets)
  (define-key nov-mode-map (kbd "C-j") 'shrface-next-headline)
  (define-key nov-mode-map (kbd "C-k") 'shrface-previous-headline)
  (define-key nov-mode-map (kbd "M-l") 'shrface-links-counsel) ; or 'shrface-links-helm or 'shrface-links-consult
  (define-key nov-mode-map (kbd "M-h") 'shrface-headline-consult)) ; or 'shrface-headline-helm or 'shrface-headline-consult
#+end_src
*** readers
#+begin_src emacs-lisp
  ;;epub reading
  (use-package nov
    :ensure t
    :mode ("\\.epub\\'" . nov-mode)
    :bind (:map nov-mode-map
                ("j" . scroll-up-line)
                ("k" . scroll-down-line)))

  (add-to-list 'auto-mode-alist '("\\.epub\\'" . nov-mode))
  (setq nov-text-width 80)
  ;; (setq nov-text-width t)
  (setq visual-fill-column-center-text t)
  (add-hook 'nov-mode-hook 'visual-line-mode)
  (add-hook 'nov-mode-hook 'visual-fill-column-mode)

  (defun my-nov-font-setup ()
    (face-remap-add-relative 'variable-pitch :family "LXGW WenKai Mono Regular"
                             :height 1.0))
  (add-hook 'nov-mode-hook 'my-nov-font-setup)

  ;;nov-rendering
  (use-package justify-kp
    :ensure t
    :vc (:url "https://github.com/Fuco1/justify-kp"))
  (setq nov-text-width t)

  (defun my-nov-window-configuration-change-hook ()
    (my-nov-post-html-render-hook)
    (remove-hook 'window-configuration-change-hook
                 'my-nov-window-configuration-change-hook
                 t))
  (defun my-nov-post-html-render-hook ()
    (if (get-buffer-window)
        (let ((max-width (pj-line-width))
              buffer-read-only)
          (save-excursion
            (goto-char (point-min))
            (while (not (eobp))
              (when (not (looking-at "^[[:space:]]*$"))
                (goto-char (line-end-position))
                (when (> (shr-pixel-column) max-width)
                  (goto-char (line-beginning-position))
                  (pj-justify)))
              (forward-line 1))))
      (add-hook 'window-configuration-change-hook
                'my-nov-window-configuration-change-hook
                nil t)))

  (add-hook 'nov-post-html-render-hook 'my-nov-post-html-render-hook)

  (require 'pdf-tools)
  (pdf-tools-install)  ; Standard activation command
  (pdf-loader-install) ; On demand loading, leads to faster startup time

  ;;calibre
  (use-package calibredb
    :ensure t
    :commands calibredb
    :bind ("\e\e b" . calibredb)
    :config
    (setq calibredb-root-dir "/Users/dingyu/Documents/calibre")
    (setq calibredb-db-dir (expand-file-name "metadata.db" calibredb-root-dir))
    (setq calibredb-library-alist '(("~/Books/books")
                                    ))
    )

  ;; bing-dict
  (use-package bing-dict :ensure t)
  (global-set-key (kbd "C-c d") 'bing-dict-brief)
  (setq bing-dict-vocabulary-save t)
  (setq bing-dict-vocabulary-file "~/Dropbox/vocabulary.org")

  ;; google-translate
  ;; (use-package google-translate
  ;;   :defines (google-translate-translation-directions-alist)
  ;;   :bind (("C-c g" . google-translate-smooth-translate))
  ;;   :config
  ;;   (setq google-translate-translation-directions-alist '(("en" . "zh-CN")))
  ;; )  
#+end_src

* Development Tools
** Eglot
** Eglot-Java
#+begin_src emacs-lisp
  (require 'eglot)

    (require 'eglot-java)

    (add-hook 'java-mode-hook #'eglot-java-mode)
    (setq eglot-java-server-install-dir "~/codebase/src/java/eclipse.jdt.ls")
    (setq eglot-java-eclipse-jdt-cache-directory "~/tmp/eglot-eclipse-jdt-cache")
#+end_src

** Database 
#+begin_src emacs-lisp

(require 'ejc-sql)
(setq clomacs-httpd-default-port 8090) ; Use a port other than 8080.
;; Require completion frontend (autocomplete or company). One of them or both.
(require 'ejc-autocomplete)
(add-hook 'ejc-sql-minor-mode-hook
          (lambda ()
            (auto-complete-mode t)
            (ejc-ac-setup)))

(setq ejc-use-flx t)
(setq ejc-flx-threshold 2)
(require 'ejc-company)
(push 'ejc-company-backend company-backends)
(add-hook 'ejc-sql-minor-mode-hook
          (lambda ()
            (company-mode t)))
(setq ejc-complete-on-dot t)
;; (company-quickhelp-mode t)
(setq ejc-completion-system 'standard)

(add-hook 'ejc-sql-minor-mode-hook
          (lambda ()
            (ejc-eldoc-setup)))
;; Performance & output customization
(add-hook 'ejc-sql-connected-hook
          (lambda ()
            (ejc-set-fetch-size 50)
            (ejc-set-max-rows 50)
            (ejc-set-show-too-many-rows-message t)
            (ejc-set-column-width-limit 25)
            (ejc-set-use-unicode t)))
(setq ejc-result-table-impl 'ejc-result-mode)
;; PostgreSQL example
(ejc-create-connection
 "PostgreSQL-db-connection"
 :classpath (concat "~/.m2/repository/org.postgresql/postgresql/42.6.0/"
                    "postgresql-42.6.0.jar")
 :subprotocol "postgresql"
 :subname "//localhost:5432/postgres"
 :user "postgres"
 :password "postgres")

#+end_src

** Tree-sitter: querying and highlighting
#+begin_src emacs-lisp
  (require 'treesit)
  (setq treesit-extra-load-path '("~/codebase/src/tree-sitter-module/dist/"))
#+end_src
** origami 
https://github.com/gregsexton/origami.el
#+begin_src emacs-lisp
  (use-package s
    :vc (:url "https://github.com/magnars/s.el" :branch master))  
  (require 'dash)
  (use-package origami :ensure t) 
    (with-eval-after-load 'origami
      (define-key origami-mode-map (kbd "C-c f") 'origami-recursively-toggle-node)
      (define-key origami-mode-map (kbd "C-c F") 'origami-toggle-all-nodes))
#+end_src
** hideshow-org
#+begin_src emacs-lisp
  (use-package hideshow-org
    :vc (:url "https://github.com/shanecelis/hideshow-org")) 
  (global-set-key (kbd"C-c h") 'hs-org/minor-mode)   
#+end_src

* Emacs Dev Tools
** bug-hunter
#+begin_src emacs-lisp


#+end_src
** Rigrep
#+begin_src emacs-lisp
(use-package rg)
#+end_src
** Magit
** Eshell
#+begin_src emacs-lisp
  ;; eshell
  (use-package xterm-color
    :commands (xterm-color-filter))
  (use-package eshell
    :after xterm-color
    :config
    (setq eshell-scroll-to-bottom-on-input t)
    (define-key eshell-mode-map (kbd "<tab>") #'company-complete)
    (define-key eshell-hist-mode-map (kbd "M-r") #'consult-history)
    (add-hook 'eshell-mode-hook
              (lambda ()
                (setenv "TERM" "xterm-256color")))
    (add-hook 'eshell-before-prompt-hook (setq xterm-color-preserve-properties t))
    (add-to-list 'eshell-preoutput-filter-functions 'xterm-color-filter)
    (setq eshell-output-filter-functions
          (remove 'eshell-handle-ansi-color eshell-output-filter-functions)))


  ;; (use-package eshell
  ;;    :config
  ;;    (setq eshell-scroll-to-bottom-on-input t)
  ;;    (setq-local tab-always-indent 'complete)
  ;;    (setq eshell-history-size 10000)
  ;;    (setq eshell-save-history-on-exit t) ;; Enable history saving on exit
  ;;    (setq eshell-hist-ignoredups t) ;; Ignore duplicatesq
  ;;    :hook
  ;;    (eshell-mode . my/eshell-hook))

  (use-package capf-autosuggest
     :hook
     (eshell-mode . capf-autosuggest-mode))

  (defun my/shell-create (name)
     "Create a custom-named eshell buffer with NAME."
     (interactive "sName: ")
     (eshell 'new)
     (let ((new-buffer-name (concat "*eshell-" name "*")))
       (rename-buffer new-buffer-name t)))

  (global-set-key (kbd "C-c s") #'my/shell-create)

#+end_src
* Coding language
** Common
[[https://github.com/Malabarba/aggressive-indent-mode][- aggressive-indent-mode]]
#+begin_src emacs-lisp
(global-aggressive-indent-mode 1)
(add-to-list 'aggressive-indent-excluded-modes 'html-mode)
#+end_src
** clojure
#+begin_src emacs-lisp
      ;; Enable desired features for all lisp modes
  (require 'clojure-ts-mode)
  (setq clojure-ts-grammar-recipes nil)

  (require 'clojure-mode)
  (setq clojure-indent-style 'always-indent
          clojure-indent-keyword-style 'always-indent
          clojure-enable-indent-specs nil

  (require 'cljsbuild-mode)
  (require 'elein)

  (defun sanityinc/enable-check-parens-on-save ()
        "Run `check-parens' when the current buffer is saved."
        (add-hook 'after-save-hook #'check-parens nil t))

  (defvar sanityinc/lispy-modes-hook
        '(enable-paredit-mode
          sanityinc/enable-check-parens-on-save)
        "Hook run in all Lisp modes.")
  (add-to-list 'sanityinc/lispy-modes-hook 'aggressive-indent-mode)

  (defun sanityinc/lisp-setup ()
        "Enable features useful in any Lisp mode."
        (run-hooks 'sanityinc/lispy-modes-hook))

  (with-eval-after-load 'clojure-mode
      (dolist (m '(clojure-mode-hook clojure-ts-mode-hook))
        (add-hook m 'sanityinc/lisp-setup)))

    (require 'cider)
    (setq nrepl-popup-stacktraces nil)
    (add-hook 'clojure-ts-mode-hook #'cider-mode)

      ;; (with-eval-after-load 'cider
      ;;   (add-hook 'cider-repl-mode-hook 'subword-mode)
      ;;   (add-hook 'cider-repl-mode-hook 'paredit-mode))

    ;; (require 'flycheck-clojure)
    ;; (with-eval-after-load 'clojure-ts-mode
    ;;     (with-eval-after-load 'cider
    ;;       (with-eval-after-load 'flycheck
    ;;         (flycheck-clojure-setup))))

#+end_src

* Misc
** Clearing
#+begin_src emacs-lisp
;; å°†åŸæœ¬æ”¾åœ¨ .emacs.d ç›®å½•ä¸‹çš„ä¸€äº›é…ç½®ä¿¡æ¯æˆ–åŠ¨æ€ä¿¡æ¯ï¼Œè½¬ç§»åˆ° etc æˆ– var å­ç›®å½•é‡Œï¼Œè®©é…ç½®ç›®å½•æ›´åŠ ç®€æ´æ¸…çˆ½
(use-package no-littering
  :ensure t)
#+end_src
(provide 'tools)

* Entertainment
** EAF
#+begin_src emacs-lisp
;; (add-to-list 'load-path "~/codebase/src/emacs-application-framework/")
;; (require 'eaf)

;; (require 'eaf-browser)
;; (require 'eaf-pdf-viewer)
;; (require 'eaf-music-player)
;; (require 'eaf-video-player)
;; (require 'eaf-js-video-player)
;; (require 'eaf-image-viewer)
;; (require 'eaf-rss-reader)
;; (require 'eaf-terminal)
;; (require 'eaf-markdown-previewer)
;; (require 'eaf-org-previewer)
;; (require 'eaf-camera)
;; (require 'eaf-git)
;; (require 'eaf-file-manager)
;; (require 'eaf-mindmap)
;; (require 'eaf-system-monitor)
;; (require 'eaf-file-browser)
;; (require 'eaf-file-sender)
;; (require 'eaf-airshare)
;; (require 'eaf-jupyter)
;; (require 'eaf-2048)
;; (require 'eaf-markmap)
;; (require 'eaf-map)
;; (require 'eaf-demo)
;; (require 'eaf-vue-demo)
;; (require 'eaf-vue-tailwindcss)
;; (require 'eaf-pyqterminal)

#+end_src
** NetEase cloud music
#+begin_src emacs-lisp
(require 'netease-cloud-music)
(require 'netease-cloud-music-ui)       ;If you want to use the default TUI, you should add this line in your configuration.
(require 'netease-cloud-music-comment)  ;If you want comment feature
#+end_src
